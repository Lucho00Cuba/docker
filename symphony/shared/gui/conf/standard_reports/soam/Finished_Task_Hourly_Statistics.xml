<?xml version="1.0" encoding="UTF-8"?>
<Report xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../report.xsd">
	<Name>Finished Task Hourly Statistics</Name>
	<DisplayName>report.displayname</DisplayName>
	<Summary>report.summary</Summary>
	<Description>report.description</Description>
	<Category>report.category</Category>
	<Version>1.2.2</Version>
	<Parameters>
		<Parameter Name="TIME" Type="TIMEPICK" Label="report.parameter.time.label">
			<Attributes>
				<Attribute Name="startTimeName" Value="StartTime"/>
				<Attribute Name="endTimeName" Value="EndTime"/>
				<Attribute Name="defaultMethod" Value="RELATIVE"/>
				<Attribute Name="timeValue" Value="1"/>
				<Attribute Name="timeUnit" Value="d"/>
				<Attribute Name="timePrecision" Value="HOUR"/>
			</Attributes>
		</Parameter>
		<Parameter Name="APP_NAME" Type="DROPDOWNLIST" DefaultValue="" Label="report.parameter.app_name.label">
			<Query DBType="STANDARD">
				<SQL>
					<![CDATA[SELECT /*+ INDEX_FFS(IDX_TASK_ATT_01) */ DISTINCT APP_NAME FROM APP_NAME_TASK_ATTRIBUTES ORDER BY APP_NAME]]>
				</SQL>
				<Field Type="Value" Column="APP_NAME" />
				<Field Type="Label" Column="APP_NAME" />
			</Query>
		</Parameter>
		<Parameter Name="CLUSTER" Type="DROPDOWNLIST" DefaultValue="" Label="report.parameter.cluster.label">
			<Attributes>
				<Attribute Name="label" Value="Cluster"/>
			</Attributes>
			<Query DBType="STANDARD">
				<SQL><![CDATA[
					SELECT /*+ INDEX_FFS(IDX_TASK_ATT_02) */ DISTINCT CLUSTER_NAME FROM APP_NAME_TASK_ATTRIBUTES ORDER BY CLUSTER_NAME
					]]></SQL>
				<Field Type="Value" Column="CLUSTER_NAME"/>
				<Field Type="Label" Column="CLUSTER_NAME"/>
			</Query>
		</Parameter>
	</Parameters>
	<Queries>
		<Query DBType="ORACLE">
			<SQL><![CDATA[
(SELECT TIME_STAMP, COUNT(*) AS NUM_TASK, TASK_STATE
FROM
(SELECT TO_DATE(TO_CHAR(END_TIME,'yyyy/mm/ddhh24'),'yyyy/mm/ddhh24') AS TIME_STAMP, TASK_STATE
	FROM TASK_ATTRIBUTES
	WHERE (END_TIME >= %%%StartTime%%% AND END_TIME < %%%EndTime%%%)
		AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
		AND (TASK_STATE = 'Done' OR TASK_STATE = 'Error')
		AND APP_NAME = %%%APP_NAME%%% 
) temp
GROUP BY TIME_STAMP, TASK_STATE
)
UNION ALL
(SELECT TIME_STAMP, COUNT(*) AS NUM_TASK, 'Canceled' AS TASK_STATE
FROM
(SELECT TO_DATE(TO_CHAR(END_TIME,'yyyy/mm/ddhh24'),'yyyy/mm/ddhh24') AS TIME_STAMP
	FROM TASK_ATTRIBUTES
	WHERE (END_TIME >= %%%StartTime%%% AND END_TIME < %%%EndTime%%%) 
		AND CLUSTER_NAME IN (%%%CLUSTER%%%)
		AND (TASK_STATE = 'Pending' OR TASK_STATE = 'Canceled') 
		AND APP_NAME = %%%APP_NAME%%% 
) temp 
GROUP BY TIME_STAMP
)
ORDER BY TIME_STAMP
			]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
			<Parameter Name="APP_NAME" Type="STRING"/>
		</Query>
		<Query DBType="MYSQL">
			<SQL><![CDATA[
(SELECT TIME_STAMP, COUNT(*) AS NUM_TASK, TASK_STATE
FROM 
(SELECT CAST(DATE_FORMAT(END_TIME, '%Y-%m-%d %H:00:00') AS DATETIME) AS TIME_STAMP, TASK_STATE
	FROM TASK_ATTRIBUTES
	WHERE (END_TIME >= %%%StartTime%%% AND END_TIME < %%%EndTime%%%) 
		AND CLUSTER_NAME IN (%%%CLUSTER%%%)
		AND (TASK_STATE = 'Done' OR TASK_STATE = 'Error')
		AND APP_NAME = %%%APP_NAME%%% 
) temp
GROUP BY TIME_STAMP, TASK_STATE
)
UNION ALL
(SELECT TIME_STAMP, COUNT(*) AS NUM_TASK, 'Canceled' AS TASK_STATE
FROM 
(SELECT CAST(DATE_FORMAT(END_TIME, '%Y-%m-%d %H:00:00') AS DATETIME) AS TIME_STAMP
	FROM TASK_ATTRIBUTES
	WHERE (END_TIME >= %%%StartTime%%% AND END_TIME < %%%EndTime%%%) 
		AND CLUSTER_NAME IN (%%%CLUSTER%%%)
		AND (TASK_STATE = 'Pending' OR TASK_STATE = 'Canceled') 
		AND APP_NAME = %%%APP_NAME%%% 
) temp 
GROUP BY TIME_STAMP
)
ORDER BY TIME_STAMP

			]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
			<Parameter Name="APP_NAME" Type="STRING"/>
		</Query>
		<Query DBType="DERBY">
			<SQL><![CDATA[
(SELECT TIME_STAMP, COUNT(*) AS NUM_TASK, TASK_STATE
FROM
(SELECT TIMESTAMP(DATE(END_TIME),SUBSTR(CHAR(TIME(END_TIME)), 1, 3)||'00:00') AS TIME_STAMP, TASK_STATE
	FROM TASK_ATTRIBUTES
	WHERE (END_TIME >= %%%StartTime%%% AND END_TIME < %%%EndTime%%%) 
		AND CLUSTER_NAME IN (%%%CLUSTER%%%)
		AND (TASK_STATE = 'Done' OR TASK_STATE = 'Error')
		AND APP_NAME = %%%APP_NAME%%% 
) temp
GROUP BY TIME_STAMP, TASK_STATE
)
UNION ALL
(SELECT TIME_STAMP, COUNT(*) AS NUM_TASK, CAST('Canceled' AS VARCHAR(26)) AS TASK_STATE
FROM
(SELECT TIMESTAMP(DATE(END_TIME),SUBSTR(CHAR(TIME(END_TIME)), 1, 3)||'00:00') AS TIME_STAMP
	FROM TASK_ATTRIBUTES
	WHERE (END_TIME >= %%%StartTime%%% AND END_TIME < %%%EndTime%%%) 
		AND CLUSTER_NAME IN (%%%CLUSTER%%%)
		AND (TASK_STATE = 'Pending' OR TASK_STATE = 'Canceled') 
		AND APP_NAME = %%%APP_NAME%%% 
) temp 
GROUP BY TIME_STAMP
)
ORDER BY TIME_STAMP
			]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
			<Parameter Name="APP_NAME" Type="STRING"/>
		</Query>
		<Query DBType="SQLSERVER">
			<SQL><![CDATA[
(SELECT TIME_STAMP, COUNT(*) AS NUM_TASK, TASK_STATE
FROM 
(SELECT CONVERT(DATETIME, SUBSTRING(CONVERT(VARCHAR, END_TIME, 120), 1, 13) + ':00:00', 120) AS TIME_STAMP, TASK_STATE
	FROM TASK_ATTRIBUTES
	WHERE (END_TIME >= %%%StartTime%%% AND END_TIME < %%%EndTime%%%) 
		AND CLUSTER_NAME IN (%%%CLUSTER%%%)
		AND (TASK_STATE = 'Done' OR TASK_STATE = 'Error')
		AND APP_NAME = %%%APP_NAME%%% 
) temp
GROUP BY TIME_STAMP, TASK_STATE
)
UNION ALL
(SELECT TIME_STAMP, COUNT(*) AS NUM_TASK, 'Canceled' AS TASK_STATE
FROM 
(SELECT CONVERT(DATETIME, SUBSTRING(CONVERT(VARCHAR, END_TIME, 120), 1, 13) + ':00:00', 120) AS TIME_STAMP
	FROM TASK_ATTRIBUTES
	WHERE (END_TIME >= %%%StartTime%%% AND END_TIME < %%%EndTime%%%) 
		AND CLUSTER_NAME IN (%%%CLUSTER%%%)
		AND (TASK_STATE = 'Pending' OR TASK_STATE = 'Canceled') 
		AND APP_NAME = %%%APP_NAME%%% 
) temp 
GROUP BY TIME_STAMP
)
ORDER BY TIME_STAMP

			]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
			<Parameter Name="APP_NAME" Type="STRING"/>
		</Query>
		<Query DBType="DB2">
			<SQL><![CDATA[
(SELECT TIME_STAMP, COUNT(*) AS NUM_TASK, TASK_STATE
FROM
(SELECT TO_DATE(TO_CHAR(END_TIME,'yyyy/mm/ddhh24'),'yyyy/mm/ddhh24') AS TIME_STAMP, TASK_STATE
	FROM TASK_ATTRIBUTES
	WHERE (END_TIME >= %%%StartTime%%% AND END_TIME < %%%EndTime%%%)
		AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
		AND (TASK_STATE = 'Done' OR TASK_STATE = 'Error')
		AND APP_NAME = %%%APP_NAME%%% 
) temp
GROUP BY TIME_STAMP, TASK_STATE
)
UNION ALL
(SELECT TIME_STAMP, COUNT(*) AS NUM_TASK, 'Canceled' AS TASK_STATE
FROM
(SELECT TO_DATE(TO_CHAR(END_TIME,'yyyy/mm/ddhh24'),'yyyy/mm/ddhh24') AS TIME_STAMP
	FROM TASK_ATTRIBUTES
	WHERE (END_TIME >= %%%StartTime%%% AND END_TIME < %%%EndTime%%%) 
		AND CLUSTER_NAME IN (%%%CLUSTER%%%)
		AND (TASK_STATE = 'Pending' OR TASK_STATE = 'Canceled') 
		AND APP_NAME = %%%APP_NAME%%% 
) temp 
GROUP BY TIME_STAMP
)
ORDER BY TIME_STAMP
			]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
			<Parameter Name="APP_NAME" Type="STRING"/>
		</Query>
	</Queries>
	<Layouts>
	<Layout>
	<!-- The Type refer the report type. e.g. LineChart, Table, ClusteredBarChart, StackedBarChart -->
	<Type>STACKED_BAR_CHART</Type>
	<Title>report.layout.title</Title>
			<Subtitles>
				<Subtitle Variables="%%%CLUSTER%%%">report.layout.subtitle1</Subtitle>
				<Subtitle Variables="%%%APP_NAME%%%">report.layout.subtitle2</Subtitle>
		        <Subtitle Variables="%%%REAL_START_TIME%%%,%%%REAL_END_TIME%%%">report.layout.subtitle3</Subtitle>
			</Subtitles>
		<!-- The label will display in chart Time-->
		<X-Axis Label="report.layout.x-axis.label" Type="TIME" Start="%%%REAL_START_TIME%%%" End="%%%REAL_END_TIME%%%" Period="1H">
			<!-- The column map the name from sql statement. Type refer maybe Timestamp and Catetory(String), The Period attribute only for Timestamp type.-->
			<Column>TIME_STAMP</Column>
		</X-Axis>
		<Y-Axis Label="report.layout.y-axis.label" Format="###,###,###,##0"/>
		<Series>
			<FromRows ValueColumn="NUM_TASK">
				<Column>TASK_STATE</Column>
			</FromRows>
		</Series>
	</Layout>
	</Layouts>
	<DataExports>
		<DataExport Name="DEFAULT">
			<Column Name="TIME_STAMP" Label="report.data_exports.time_stamp.label" />
			<Column Name="NUM_TASK" Label="report.data_exports.num_task.label" />
			<Column Name="TASK_STATE" Label="report.data_exports.task_state.label" />
		</DataExport>
	</DataExports>
	<Variables>
		<Variable Name="CLUSTER" Target="CLUSTER" Source="REQUEST" />
		<Variable Name="StartTime" Target="StartTime" Source="REQUEST" />
		<Variable Name="EndTime" Target="EndTime" Source="REQUEST" />
		<Variable Name="APP_NAME" Target="APP_NAME" Source="REQUEST" />
		<Variable Name="REAL_START_TIME" Target="REAL_START_TIME" Source="REAL_TIME_RANGE">
			<Format	Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat"	Pattern="yyyy-MM-dd HH:mm" />
		</Variable>
		<Variable Name="REAL_END_TIME" Target="REAL_END_TIME" Source="REAL_TIME_RANGE">
			<Format	Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat"	Pattern="yyyy-MM-dd HH:mm" />
		</Variable>
	</Variables>
	<Sources>
		<Source Name="REQUEST" Plug-in="com.platform.perf.report.config.var.source.RequestVariableSource" />
		<Source Name="REAL_TIME_RANGE"	Plug-in="com.platform.perf.report.config.var.source.RealTimeRangeSource">
			<Parameter Name="START_TIME">%%%StartTime%%%</Parameter>
			<Parameter Name="END_TIME">%%%EndTime%%%</Parameter>
		</Source>
	</Sources>
</Report>
