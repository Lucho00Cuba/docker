<?xml version="1.0" encoding="UTF-8"?>
<Report xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../report.xsd">
	<Name>Resource Allocation vs Resource Plan</Name>
	<DisplayName>report.displayname</DisplayName>
	<Summary>report.summary</Summary>
	<Description>report.description</Description>
	<Category>report.category</Category>
	<Parameters>
		<Parameter Name="TIME" Type="TIMEPICK" Label="report.parameter.time.label">
			<Attributes>
				<Attribute Name="startTimeName" Value="StartTime"/>
				<Attribute Name="endTimeName" Value="EndTime"/>
				<Attribute Name="defaultMethod" Value="RELATIVE"/>
				<Attribute Name="timeValue" Value="1"/>
				<Attribute Name="timeUnit" Value="d"/>
			</Attributes>
		</Parameter>
		<Parameter Name="CONSUMER" Type="DROPDOWNLIST" DefaultValue="" Label="report.parameter.consumer.label">		
			<Query DBType="STANDARD">
				<SQL><![CDATA[SELECT DISTINCT CONSUMER_NAME FROM CONSUMER_RESOURCE_ALLOCATION
						UNION
						SELECT DISTINCT CONSUMER_NAME FROM CONSUMER_DEMAND]]></SQL>
				<Field Type="Value" Column="CONSUMER_NAME"/>
				<Field Type="Label" Column="CONSUMER_NAME"/>
			</Query>
		</Parameter>
		<Parameter Name="CLUSTER" Type="DROPDOWNLIST" DefaultValue="" Label="report.parameter.cluster.label">		
			<Attributes>
				<Attribute Name="label" Value="Cluster"/>
			</Attributes>
			<Query DBType="STANDARD">
				<SQL><![CDATA[
					SELECT DISTINCT CLUSTER_NAME FROM CONSUMER_RESOURCE_ALLOCATION ORDER BY CLUSTER_NAME
					]]></SQL>
				<Field Type="Value" Column="CLUSTER_NAME"/>
				<Field Type="Label" Column="CLUSTER_NAME"/>
			</Query>
		</Parameter>
	</Parameters>
	<Queries>
		<Query DBType="ORACLE">
			<SQL><![CDATA[
SELECT TIME_STAMP, SUM(NVL(ALLOCATED_OWN, 0) + NVL(ALLOCATED_BORROW, 0) + NVL(ALLOCATED_SHARE, 0)) AS VALUE, 'allocation' AS SERIES
  FROM CONSUMER_RESOURCE_ALLOCATION
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP  
UNION ALL
SELECT TIME_STAMP, SUM(PLANNED_OWN) AS VALUE, 'plan' AS SERIES
  FROM CONSUMER_RESOURCE_ALLOCATION
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP  
UNION ALL
SELECT TIME_STAMP, SUM(MAX_REQUESTED) AS VALUE, 'demand' AS SERIES
  FROM  CONSUMER_DEMAND
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
  ORDER BY TIME_STAMP
			]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="CONSUMER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
		</Query>
		<Query DBType="POSTGRESQL">
			<SQL><![CDATA[
SELECT TIME_STAMP, SUM(COALESCE(ALLOCATED_OWN, 0) + COALESCE(ALLOCATED_BORROW, 0) + COALESCE(ALLOCATED_SHARE, 0)) AS VALUE, 'allocation' AS SERIES
   FROM CONSUMER_RESOURCE_ALLOCATION
   WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
   GROUP BY TIME_STAMP_GMT, TIME_STAMP  
UNION ALL
SELECT TIME_STAMP, SUM(PLANNED_OWN) AS VALUE, 'plan' AS SERIES
   FROM CONSUMER_RESOURCE_ALLOCATION
   WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
   GROUP BY TIME_STAMP_GMT, TIME_STAMP  
UNION ALL
SELECT TIME_STAMP, SUM(MAX_REQUESTED) AS VALUE, 'demand' AS SERIES
   FROM  CONSUMER_DEMAND
   WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
   GROUP BY TIME_STAMP_GMT, TIME_STAMP
   ORDER BY TIME_STAMP
	   		]]></SQL>												           <Parameter Name="CLUSTER" Type="STRING"/>							                      <Parameter Name="CONSUMER" Type="STRING"/>
		        <Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
		 </Query>
		<Query DBType="MYSQL">
			<SQL><![CDATA[
SELECT TIME_STAMP, SUM(COALESCE(ALLOCATED_OWN, 0 )+ COALESCE(ALLOCATED_BORROW, 0) + COALESCE(ALLOCATED_SHARE, 0)) AS VALUE, 'allocation' AS SERIES
  FROM CONSUMER_RESOURCE_ALLOCATION
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
UNION ALL
SELECT TIME_STAMP, SUM(PLANNED_OWN) AS VALUE, 'plan' AS SERIES
  FROM CONSUMER_RESOURCE_ALLOCATION
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
UNION ALL
SELECT TIME_STAMP, SUM(MAX_REQUESTED) AS VALUE, 'demand' AS SERIES
  FROM CONSUMER_DEMAND
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
  ORDER BY TIME_STAMP
  			]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="CONSUMER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
		</Query>
		<Query DBType="DERBY">
			<SQL><![CDATA[
SELECT TIME_STAMP, SUM(CASE WHEN ALLOCATED_OWN IS NULL THEN 0 ELSE ALLOCATED_OWN END
    + CASE WHEN ALLOCATED_BORROW IS NULL THEN 0 ELSE ALLOCATED_BORROW END
    + CASE WHEN ALLOCATED_SHARE IS NULL THEN 0 ELSE ALLOCATED_SHARE END) AS VALUE, CAST('allocation' AS VARCHAR(16)) AS SERIES
  FROM CONSUMER_RESOURCE_ALLOCATION
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
UNION ALL
SELECT TIME_STAMP, SUM(PLANNED_OWN) AS VALUE, CAST('plan' AS VARCHAR(16)) AS SERIES
  FROM CONSUMER_RESOURCE_ALLOCATION
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
UNION ALL
SELECT TIME_STAMP, SUM(MAX_REQUESTED) AS VALUE, CAST('demand' AS VARCHAR(16)) AS SERIES
  FROM CONSUMER_DEMAND
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
  ORDER BY TIME_STAMP
  			]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="CONSUMER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
		</Query>
		<Query DBType="SQLSERVER">
			<SQL><![CDATA[
SELECT TIME_STAMP, SUM(COALESCE(ALLOCATED_OWN, 0 )+ COALESCE(ALLOCATED_BORROW, 0) + COALESCE(ALLOCATED_SHARE, 0)) AS VALUE, 'allocation' AS SERIES
  FROM CONSUMER_RESOURCE_ALLOCATION
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
UNION ALL
SELECT TIME_STAMP, SUM(PLANNED_OWN) AS VALUE, 'plan' AS SERIES
  FROM CONSUMER_RESOURCE_ALLOCATION
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
UNION ALL
SELECT TIME_STAMP, SUM(MAX_REQUESTED) AS VALUE, 'demand' AS SERIES
  FROM CONSUMER_DEMAND
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
  ORDER BY TIME_STAMP
  			]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="CONSUMER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
		</Query>
		<Query DBType="DB2">
			<SQL><![CDATA[
SELECT TIME_STAMP, SUM(COALESCE(ALLOCATED_OWN, 0) + COALESCE(ALLOCATED_BORROW, 0) + COALESCE(ALLOCATED_SHARE, 0)) AS VALUE, 'allocation' AS SERIES
  FROM CONSUMER_RESOURCE_ALLOCATION
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
UNION ALL
SELECT TIME_STAMP, SUM(PLANNED_OWN) AS VALUE, CAST('plan' AS VARCHAR(16)) AS SERIES
  FROM CONSUMER_RESOURCE_ALLOCATION
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
UNION ALL
SELECT TIME_STAMP, SUM(MAX_REQUESTED) AS VALUE, CAST('demand' AS VARCHAR(16)) AS SERIES
  FROM CONSUMER_DEMAND
  WHERE CLUSTER_NAME IN (%%%CLUSTER%%%) AND CONSUMER_NAME = %%%CONSUMER%%% AND (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP < %%%EndTime%%%)
  GROUP BY TIME_STAMP_GMT, TIME_STAMP
  ORDER BY TIME_STAMP
  			]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="CONSUMER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
		</Query>
	</Queries>
	<Layouts>
		<!-- The Type refer the report type. e.g. LINE_CHART, TABLE, BAR_CHART, STACKED_BAR_CHART -->
		<Layout>
			<Type>LINE_CHART</Type>
			<Title>report.layout.title</Title>			
			<Subtitles>
				<Subtitle Variables="%%%CLUSTER%%%">report.layout.subtitle1</Subtitle>
		 		<Subtitle Variables="%%%CONSUMER%%%">report.layout.subtitle2</Subtitle>
		 		<Subtitle Variables="%%%REAL_START_TIME%%%,%%%REAL_END_TIME%%%">report.layout.subtitle3</Subtitle>
			</Subtitles>
			<!-- The label will display in chart Time-->
			<X-Axis Label="report.layout.x-axis.label" Type="TIME" Start="%%%REAL_START_TIME%%%" End="%%%REAL_END_TIME%%%" Period="5m">			
				<!-- The column map the name from sql statement. Type refer maybe Timestamp and Catetory(String), The Period attribute only for Timestamp type.-->
				<Column>TIME_STAMP</Column>
			</X-Axis>
			<Y-Axis Label="report.layout.y-axis.label" Format="report.layout.y-axis.format"/>			
			<Series>
				<FromRows ValueColumn="VALUE">
					<Column>SERIES</Column>
				</FromRows>
			</Series>
			<DataLoader>egoconsumerresloader</DataLoader>
		</Layout>
	</Layouts>
	<DataExports>
		<DataExport Name="DEFAULT">
			<Column Name="TIME_STAMP" Label="report.data_exports.time.label" />
			<Column Name="VALUE" Label="report.data_exports.value.label" />
			<Column Name="SERIES" Label="report.data_exports.series.label" />
		</DataExport>
	</DataExports>
	<Variables>
		<Variable Name="CLUSTER" Target="CLUSTER" Source="REQUEST" />
		<Variable Name="StartTime" Target="StartTime" Source="REQUEST" />
		<Variable Name="EndTime" Target="EndTime" Source="REQUEST" />

		<Variable Name="CONSUMER" Target="CONSUMER" Source="REQUEST" />

		<Variable Name="REAL_START_TIME" Target="REAL_START_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM-dd HH:mm" />
		</Variable>

		<Variable Name="REAL_END_TIME" Target="REAL_END_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM-dd HH:mm" />
		</Variable>
	</Variables>
	<Sources>
		<Source Name="REQUEST" Plug-in="com.platform.perf.report.config.var.source.RequestVariableSource" />
		<Source Name="REAL_TIME_RANGE" Plug-in="com.platform.perf.report.config.var.source.RealTimeRangeSource">
			<Parameter Name="START_TIME">%%%StartTime%%%</Parameter>
			<Parameter Name="END_TIME">%%%EndTime%%%</Parameter>
		</Source>
	</Sources>

</Report>
