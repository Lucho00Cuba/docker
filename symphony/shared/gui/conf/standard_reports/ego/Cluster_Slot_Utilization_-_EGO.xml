<?xml version="1.0" encoding="UTF-8"?>
<Report xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../report.xsd">
	<Name>Cluster Slot Utilization - EGO</Name>
	<DisplayName>report.displayname</DisplayName>
	<Summary>report.summary</Summary>
	<Description>report.description</Description>
	<Category>report.category</Category>
	<Parameters>
		<Parameter Name="TIME" Type="MONTHPICK" Label="report.parameter.time.label">
			<Attributes>
				<Attribute Name="startTimeName" Value="StartTime"/>
				<Attribute Name="endTimeName" Value="EndTime"/>
				<Attribute Name="period" Value="12"/>
			</Attributes>
		</Parameter>
		<Parameter Name="CLUSTER" Type="DROPDOWNLIST" DefaultValue="" Label="report.parameter.cluster.label">
			<Attributes>
				<Attribute Name="label" Value="Cluster"/>
			</Attributes>
			<Query DBType="STANDARD">
				<SQL><![CDATA[
					SELECT DISTINCT CLUSTER_NAME FROM RESOURCES_RESOURCE_METRICS ORDER BY CLUSTER_NAME
					]]></SQL>
				<Field Type="Value" Column="CLUSTER_NAME"/>
				<Field Type="Label" Column="CLUSTER_NAME"/>
			</Query>
		</Parameter>
	</Parameters>
	<Queries>
		<!--
			<Query DBType="MySQL"><SQL><![CDATA[select TIME_STAMP as Timestamp, HOSTLIST_ID as HOST,MAX_VALUE as Max, MIN_VALUE as Min, FREE_VALUE as Free from ALLOCATION_REQUEST_EVENT where ParamA=%%%ParamA%%% and ParamB=%%%ParamB%%% and Timestamp between %%%T1%%% and %%%t2%%%]]></SQL></Query>
		-->
		<Query DBType="ORACLE">
			<SQL><![CDATA[
SELECT TIME_STAMP , AVG(UTIL_VAL) AS PRESENT_RANGE
FROM
(
SELECT  TRUNC(TEMP1.TIME_STAMP,'HH24') AS TIME_STAMP, (SUM(TOTAL_SLOTS)-SUM(FREE_SLOTS))/SUM(TOTAL_SLOTS) AS UTIL_VAL
FROM
(
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM  AS TOTAL_SLOTS, RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
	 AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='slot' AND RESOURCE_TYPE = 'host' AND ATTRIBUTE_VALUE_NUM <> 0) TEMP1
LEFT JOIN
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM AS FREE_SLOTS , RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
	 AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='freeslot' AND RESOURCE_TYPE= 'host') TEMP2
ON TEMP1.TIME_STAMP = TEMP2.TIME_STAMP
AND TEMP1.RESOURCE_NAME = TEMP2.RESOURCE_NAME
)
GROUP BY TEMP1.TIME_STAMP
)TEMP3
GROUP BY TIME_STAMP
ORDER BY TIME_STAMP
				]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
		</Query>
		<Query DBType="POSTGRESQL">
                       <SQL><![CDATA[
SELECT TIME_STAMP , AVG(UTIL_VAL) AS PRESENT_RANGE
FROM
(
SELECT  DATE_TRUNC('hour',TEMP1.TIME_STAMP) AS TIME_STAMP, (SUM(TOTAL_SLOTS)-SUM(FREE_SLOTS))/SUM(TOTAL_SLOTS) AS UTIL_VAL
FROM
(
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM  AS TOTAL_SLOTS, RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
         AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='slot' AND RESOURCE_TYPE = 'host' AND ATTRIBUTE_VALUE_NUM <> 0) TEMP1
LEFT JOIN
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM AS FREE_SLOTS , RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
         AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='freeslot' AND RESOURCE_TYPE= 'host') TEMP2
ON TEMP1.TIME_STAMP = TEMP2.TIME_STAMP
AND TEMP1.RESOURCE_NAME = TEMP2.RESOURCE_NAME
)
GROUP BY TEMP1.TIME_STAMP
)TEMP3
GROUP BY TIME_STAMP
ORDER BY TIME_STAMP
                                ]]></SQL>
                        <Parameter Name="CLUSTER" Type="STRING"/>
                        <Parameter Name="StartTime" Type="TIMESTAMP"/>
                        <Parameter Name="EndTime" Type="TIMESTAMP"/>
                </Query>
		<Query DBType="MYSQL">
			<SQL><![CDATA[
SELECT TIME_STAMP , AVG(UTIL_VAL) AS PRESENT_RANGE
FROM
(
SELECT  CAST(DATE_FORMAT(TEMP1.TIME_STAMP, '%Y-%m-%d %H:00:00') AS DATETIME) AS TIME_STAMP, (SUM(TOTAL_SLOTS)-SUM(FREE_SLOTS))/SUM(TOTAL_SLOTS) AS UTIL_VAL
FROM
(
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM  AS TOTAL_SLOTS, RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
	 AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='slot' AND RESOURCE_TYPE = 'host' AND ATTRIBUTE_VALUE_NUM <> 0) TEMP1
LEFT JOIN
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM AS FREE_SLOTS , RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
	 AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='freeslot' AND RESOURCE_TYPE= 'host') TEMP2
ON TEMP1.TIME_STAMP = TEMP2.TIME_STAMP
AND TEMP1.RESOURCE_NAME = TEMP2.RESOURCE_NAME
)
GROUP BY TEMP1.TIME_STAMP
)TEMP3
GROUP BY TIME_STAMP
ORDER BY TIME_STAMP
				]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
		</Query>
		<Query DBType="DERBY">
			<SQL><![CDATA[
SELECT TIME_STAMP , AVG(UTIL_VAL) AS PRESENT_RANGE
FROM
(
SELECT  TIMESTAMP(DATE(TEMP1.TIME_STAMP),SUBSTR(CHAR(TIME(TEMP1.TIME_STAMP)), 1, 3)||'00:00') AS TIME_STAMP, (SUM(TOTAL_SLOTS)-SUM(FREE_SLOTS))/SUM(TOTAL_SLOTS) AS UTIL_VAL
FROM
(
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM  AS TOTAL_SLOTS, RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
	 AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='slot' AND RESOURCE_TYPE = 'host' AND ATTRIBUTE_VALUE_NUM <> 0) TEMP1
LEFT JOIN
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM AS FREE_SLOTS , RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
	 AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='freeslot' AND RESOURCE_TYPE= 'host') TEMP2
ON TEMP1.TIME_STAMP = TEMP2.TIME_STAMP
AND TEMP1.RESOURCE_NAME = TEMP2.RESOURCE_NAME
)
GROUP BY TEMP1.TIME_STAMP
)TEMP3
GROUP BY TIME_STAMP
ORDER BY TIME_STAMP
				]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
		</Query>
		<Query DBType="SQLSERVER">
			<SQL><![CDATA[
SELECT TIME_STAMP , AVG(UTIL_VAL) AS PRESENT_RANGE
FROM
(
SELECT  CONVERT(DATETIME, SUBSTRING(CONVERT(VARCHAR, TEMP1.TIME_STAMP, 120), 1, 13) + ':00:00', 120) AS TIME_STAMP, (SUM(TOTAL_SLOTS)-SUM(FREE_SLOTS))/SUM(TOTAL_SLOTS) AS UTIL_VAL
FROM
(
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM  AS TOTAL_SLOTS, RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
	 AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='slot' AND RESOURCE_TYPE = 'host' AND ATTRIBUTE_VALUE_NUM <> 0) TEMP1
LEFT JOIN
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM AS FREE_SLOTS , RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
	 AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='freeslot' AND RESOURCE_TYPE= 'host') TEMP2
ON TEMP1.TIME_STAMP = TEMP2.TIME_STAMP
AND TEMP1.RESOURCE_NAME = TEMP2.RESOURCE_NAME
)
GROUP BY TEMP1.TIME_STAMP
)TEMP3
GROUP BY TIME_STAMP
ORDER BY TIME_STAMP
				]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
		</Query>
				<Query DBType="DB2">
			<SQL><![CDATA[
SELECT TIME_STAMP , AVG(UTIL_VAL) AS PRESENT_RANGE
FROM
(
SELECT  TRUNC(TEMP1.TIME_STAMP,'HH24') AS TIME_STAMP, (SUM(TOTAL_SLOTS)-SUM(FREE_SLOTS))/SUM(TOTAL_SLOTS) AS UTIL_VAL
FROM
(
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM  AS TOTAL_SLOTS, RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
	 AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='slot' AND RESOURCE_TYPE = 'host') TEMP1
LEFT JOIN
(SELECT TIME_STAMP,ATTRIBUTE_VALUE_NUM AS FREE_SLOTS , RESOURCE_NAME
     FROM RESOURCE_METRICS
     WHERE (TIME_STAMP >= %%%StartTime%%% AND TIME_STAMP< %%%EndTime%%%)
	 AND CLUSTER_NAME IN (%%%CLUSTER%%%) 
  AND ATTRIBUTE_NAME='freeslot' AND RESOURCE_TYPE= 'host') TEMP2
ON TEMP1.TIME_STAMP = TEMP2.TIME_STAMP
AND TEMP1.RESOURCE_NAME = TEMP2.RESOURCE_NAME
)
GROUP BY TEMP1.TIME_STAMP
)TEMP3
GROUP BY TIME_STAMP
ORDER BY TIME_STAMP
				]]></SQL>
			<Parameter Name="CLUSTER" Type="STRING"/>
			<Parameter Name="StartTime" Type="TIMESTAMP"/>
			<Parameter Name="EndTime" Type="TIMESTAMP"/>
		</Query>
	</Queries>
	<Layouts>
	<Layout>
	<!-- The Type refer the report type. e.g. LineChart, Table, ClusteredBarChart, StackedBarChart -->
	<Type>GRID_TABLE</Type>
	<Title>report.layout.title</Title>	
			<Subtitles>
				<Subtitle Variables="%%%CLUSTER%%%">report.layout.subtitle1</Subtitle>
				<Subtitle Variables="%%%REAL_START_TIME%%%,%%%REAL_END_TIME%%%">report.layout.subtitle2</Subtitle>
			</Subtitles>
			<Size Width="720"/>
	</Layout>
	</Layouts>
		<DataExports>
		<DataExport Name="DEFAULT">
			<Column Name="TIME_STAMP" Label="report.data_exports.time_stamp.label" />
			<Column Name="PRESENT_RANGE" Label="report.data_exports.present_range.label" />
		</DataExport>
	</DataExports>
	<Variables>
		<Variable Name="CLUSTER" Target="CLUSTER" Source="REQUEST" />
		<Variable Name="StartTime" Target="StartTime" Source="REQUEST" />
		<Variable Name="EndTime" Target="EndTime" Source="REQUEST" />
		<Variable Name="REAL_START_TIME" Target="REAL_START_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM-dd HH:mm" />
		</Variable>
		
		<Variable Name="REAL_END_TIME" Target="REAL_END_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM-dd HH:mm" />
		</Variable>
	</Variables>
	<Sources>
		<Source Name="REQUEST" Plug-in="com.platform.perf.report.config.var.source.RequestVariableSource" />
		<Source Name="REAL_TIME_RANGE" Plug-in="com.platform.perf.report.config.var.source.RealTimeRangeSource">
			<Parameter Name="START_TIME">%%%StartTime%%%</Parameter>
			<Parameter Name="END_TIME">%%%EndTime%%%</Parameter>
		</Source>
	</Sources>
</Report>
