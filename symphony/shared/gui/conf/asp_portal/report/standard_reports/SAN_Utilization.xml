<?xml version="1.0" encoding="UTF-8"?>
<Report xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="report.xsd">
	<Name>SAN Utilization</Name>
	<DisplayName>利用率</DisplayName>
	<Summary>统计存储系统分区的利用率。</Summary>
	<Description><![CDATA[
	<h3>目的</h3>
	<ul type="disc">
		<li>该报表显示所选时间范围内存储系统某分区在每个采样点的利用率。</li>
	</ul>
	<h3>数据描述</h3>
	<ul type="disc">
		<li>该报表显示在指定时间内所选存储系统分区的利用率。。</li>
	</ul>
	<h3>分析</h3>
	<ul type="disc">
		<li>了解相对时间某存储系统分区的使用趋势。</li>
		<li>确定某存储系统分区使用峰值的时间。</li>
		<li>确定在每个采样点上某存储系统分区的利用率。</li>
		<li>比较不同存储系统分区的利用率。</li>
	</ul>
]]></Description>
	<Category>LSF</Category>
	<Folder>SANUsage</Folder>
	<Parameters>
		<Parameter Name="DATA_GRANULARITY" Type="DROPDOWNLIST" Label="统计时间粒度">
			<Attributes>
				<Attribute Name="label" Value="Usage" />
				<Attribute Name="defaultValue" Value="HOUR" />
				<Attribute Name="onChange" Value="TIME.setTimePrecision(this.value)" />
			</Attributes>
			<ListValue>
				<Item Value="MINUTE" Label="按采样点" />
				<Item Value="HOUR" Label="按小时" />
				<Item Value="DAY" Label="按天" />
			</ListValue>
		</Parameter>
		<Parameter Name="TIME" Type="TIMEPICK" Label="时间">
			<Attributes>
				<Attribute Name="startTimeName" Value="StartTime"/>
				<Attribute Name="endTimeName" Value="EndTime"/>
				<Attribute Name="defaultMethod" Value="MONTH"/>
				<Attribute Name="timeValue" Value="1"/>
				<Attribute Name="timeUnit" Value="d"/>
				<Attribute Name="timePrecision" Value="HOUR"/>
			</Attributes>
		</Parameter>
		<Parameter Name="RESOURCE_NAME" Type="LISTBOX" DefaultValue="" Label="存储系统分区">
			<Attributes>
				<Attribute Name="label" Value="存储系统分区"/>
				<Attribute Name="size" Value="5"/>
				<Attribute Name="showAll" Value="true"/>
			</Attributes>
			<Query DBType="STANDARD">
				<SQL><![CDATA[SELECT DISTINCT RESOURCE_NAME  FROM SAN_USAGE ORDER BY RESOURCE_NAME]]></SQL>
				<Field Type="Value" Column="RESOURCE_NAME"/>
				<Field Type="Label" Column="RESOURCE_NAME"/>
			</Query>			
		</Parameter>
	</Parameters>
	<Queries>
		<!--Usage:
		<Query DBType="MySQL"><SQL><![CDATA[select TIME_STAMP as Timestamp, HOSTLIST_ID as HOST,MAX_VALUE as Max, MIN_VALUE as Min, FREE_VALUE as Free from ALLOCATION_REQUEST_EVENT where ParamA=${ParamA} and ParamB=${ParamB} and Timestamp between ${T1} and ${t2}]]></SQL></Query>
		-->
		<Query Name="DS1" DBType="STANDARD">
			<SQL><![CDATA[
SELECT TIME_STAMP, RESOURCE_NAME, USED_BYTES/(FREE_BYTES+USED_BYTES) AS UTILIZATION  
FROM  ${TABLE_NAME}
WHERE (TIME_STAMP >= ${START_TIMESTAMP} AND TIME_STAMP < ${END_TIMESTAMP})  
  ${QUERY_CONDITION_SAN_VALUE}
ORDER BY TIME_STAMP			
			]]></SQL>
		</Query>
		<Query Name="DS2" DBType="STANDARD">
			<SQL><![CDATA[
SELECT RESOURCE_NAME, MAX(UTILIZATION) MAX_UTIL, MIN(UTILIZATION) MIN_UTIL,AVG(UTILIZATION) AVG_UTIL
FROM
(SELECT TIME_STAMP, RESOURCE_NAME, USED_BYTES/(FREE_BYTES+USED_BYTES) AS UTILIZATION  
FROM  ${TABLE_NAME}
WHERE (TIME_STAMP >= ${START_TIMESTAMP} AND TIME_STAMP < ${END_TIMESTAMP}) 
  ${QUERY_CONDITION_SAN_VALUE})
GROUP BY RESOURCE_NAME			
			]]></SQL>
		</Query>
	</Queries>
	<Layouts>
		<!-- The Type refer the report type. e.g. LineChart, Table, ClusteredBarChart, StackedBarChart -->
		<Layout>
			<Type>LINE_CHART</Type>
			<DataSetName>DS1</DataSetName>
			<Title>存储系统利用率</Title>
			<Subtitles>
				<Subtitle>从 ${REAL_START_TIME} 到 ${REAL_END_TIME}</Subtitle>
			</Subtitles>
			<Size Width="982" Height="420" />
			<!-- The label will display in chart Time-->
			<X-Axis Label="时间" Type="TIME" Start="${REAL_START_TIME}" End="${REAL_END_TIME}" Period="${X_AXIS_PERIOD}">
				<!-- The column map the name from sql statement. Type refer maybe Timestamp and Catetory(String), The Period attribute only for Timestamp type.-->
				<Column>TIME_STAMP</Column>
			</X-Axis>
			<Y-Axis Label="SAN平均利用率" Format="#,###,##0.00%"/>
			<Series>
				<FromRows ValueColumn="UTILIZATION">
					<Column>RESOURCE_NAME</Column>
				</FromRows>
			</Series>
		</Layout>
		<Layout>
			<Type>TABLE</Type>
			<DataSetName>DS2</DataSetName>
			<Title>存储系统利用率最大值、最小值、平均值统计表</Title>
			<Subtitles>
				<Subtitle>从 %%%REAL_START_TIME%%% 到 %%%REAL_END_TIME%%%</Subtitle>
			</Subtitles>
			<Size Width="980" Height="10" />
			<!-- The label will display in chart Time-->
			<TableColumns>
				<TableColumn Name="RESOURCE_NAME" Label="存储系统分区"/>
				<TableColumn Name="MAX_UTIL" Label="最大利用率" Type="NUMERIC" Format="#,###,###,##0.00%" Style="text-align:right"/>
				<TableColumn Name="MIN_UTIL" Label="最小利用率" Type="NUMERIC" Format="#,###,###,##0.00%" Style="text-align:right"/>
				<TableColumn Name="AVG_UTIL" Label="平均利用率" Type="NUMERIC" Format="#,###,###,##0.00%" Style="text-align:right"/>

			</TableColumns>
		</Layout>
	</Layouts>
	<DataExports>
		<DataExport Name="DS1">
			<Column Name="TIME_STAMP" Label="时间" />
			<Column Name="RESOURCE_NAME" Label="存储系统分区" />
			<Column Name="UTILIZATION" Label="利用率" />
		</DataExport>
		<DataExport Name="DS2">
			<Column Name="RESOURCE_NAME" Label="存储系统分区"/>
			<Column Name="MAX_UTIL" Label="最大利用率" />
			<Column Name="MIN_UTIL" Label="最小利用率" />
			<Column Name="AVG_UTIL" Label="平均利用率" />
		</DataExport>
	</DataExports>
	<Variables>
		<!-- Variables can be gotten from request -->
		<Variable Name="StartTime" Target="StartTime" Source="REQUEST" />
		<Variable Name="EndTime" Target="EndTime" Source="REQUEST" />
		<Variable Name="RESOURCE_NAME" Target="RESOURCE_NAME" Source="REQUEST" />
		<Variable Name="DATA_GRANULARITY"  Target="DATA_GRANULARITY" Source="REQUEST" />
		
		
		<!-- Variable can be gotten from X_AXIS_PERIOD_SOURCE -->
		<Variable Name="X_AXIS_PERIOD"  Target="X_AXIS_PERIOD" Source="X_AXIS_PERIOD_SOURCE" />
		
		<!-- Variable used to present report last month of database server. -->
		<Variable Name="LAST_MONTH" Target="REAL_START_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM" />
		</Variable>

		<!-- Variable used to present report current month of database server. -->
		<Variable Name="CURRENT_MONTH" Target="REAL_START_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM" />
		</Variable>

		<!-- Variable used to present absolute time of database server. -->
		<Variable Name="REAL_START_TIME" Target="REAL_START_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM-dd HH:mm" />
		</Variable>
		<Variable Name="REAL_END_TIME" Target="REAL_END_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM-dd HH:mm" />
		</Variable>
		
		<!-- Variables used to build the SQL -->
		<Variable Name="QUOTED_RESOURCE_NAME" Source="QUERY_BUILD_SOURCE" Target="RESOURCE_NAME" Function="TO_COMMA_DELIMITED_QUOTED_STRING" />
		<Variable Name="START_TIMESTAMP" Source="QUERY_BUILD_SOURCE" Target="START_TIME" Function="TO_TIMESTAMP" />
		<Variable Name="END_TIMESTAMP" Source="QUERY_BUILD_SOURCE" Target="END_TIME" Function="TO_TIMESTAMP" />
		<Variable Name="TRUNCATED_TIMESTAMP" Source="QUERY_BUILD_SOURCE" Target="TIMESTAMP_COLUMN" Function="TRUNC_TIME_TO_${DATA_GRANULARITY}" />
		<Variable Name="TABLE_NAME" Target="DATA_GRANULARITY" Source="MAP" />

		<Variable Name="QUERY_CONDITION_SAN_VALUE" Target="QUERY_CONDITION_SAN" Source="QUERY_CONDITION_SOURCE" Function="TO_COMMA_DELIMITED_QUOTED_STRING" />
	</Variables>
	<Sources>		
		<Source Name="REQUEST" Plug-in="com.platform.perf.report.config.var.source.RequestVariableSource" />
		<Source Name="REAL_TIME_RANGE" Plug-in="com.platform.perf.report.config.var.source.RealTimeRangeSource">
			<Parameter Name="START_TIME">${StartTime}</Parameter>
			<Parameter Name="END_TIME">${EndTime}</Parameter>
		</Source>
		<Source Name="PROPERTIES" Plug-in="com.platform.perf.report.config.var.source.PropertiesVariableSource" />
		<Source Name="QUERY_BUILD_SOURCE" Plug-in="com.platform.perf.report.config.var.source.QueryBuildSource">
			<Parameter Name="RESOURCE_NAME">${RESOURCE_NAME}</Parameter>
			<Parameter Name="START_TIME">${StartTime}</Parameter>
			<Parameter Name="END_TIME">${EndTime}</Parameter>
			<Parameter Name="TIMESTAMP_COLUMN">TIME_STAMP</Parameter>
		</Source>

		<Source Name="QUERY_CONDITION_SOURCE" Plug-in="com.platform.perf.report.config.var.source.QueryConditionSource">

			<Parameter Name="QUERY_CONDITION_SAN">
				<Group Operator="AND" Where="false">
					<Condition Operator="" Express="RESOURCE_NAME IN">${RESOURCE_NAME}</Condition>
				</Group>
			</Parameter>

		</Source>

		<Source Name="X_AXIS_PERIOD_SOURCE" Plug-in="com.platform.perf.report.config.var.source.DataIntervalSource">
			<Parameter Name="DATA_LOADER">sharedresusageloader</Parameter> <!-- Use this data loader name to get data interval from plc configuration file -->
			<Parameter Name="DEFAULT_INTERVAL">5m</Parameter> <!-- No interval found in plc configuration file, use this defualt value -->
			<Parameter Name="BASE_LEVEL">MINUTE</Parameter> <!-- This parameter is optional, default is MINUTE -->
			<Parameter Name="CURRENT_LEVEL">${DATA_GRANULARITY}</Parameter> <!-- This parameter is optional, default is MINUTE. The current level is not equivalent to the base level means data interval need change -->
		</Source>
		<Source Name="MAP" Plug-in="com.platform.perf.report.config.var.source.MapVariableSource" >
			<Parameter Name="VARIABLE_NAME">%%%DATA_GRANULARITY%%%</Parameter>
			<Parameter Name="MAP">
				<Map>
					<Entry>
						<Key>MINUTE</Key><Value>SAN_USAGE</Value>
					</Entry>
					<Entry>
						<Key>HOUR</Key><Value>SAN_USAGE_HOURLY</Value>
					</Entry>
					<Entry>
						<Key>DAY</Key><Value>SAN_USAGE_DAILY</Value>
					</Entry>
				</Map>
			</Parameter>
		</Source>
	</Sources>

</Report>
