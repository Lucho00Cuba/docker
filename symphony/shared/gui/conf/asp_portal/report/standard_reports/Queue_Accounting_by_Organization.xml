<?xml version="1.0" encoding="UTF-8"?>
<Report xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="report.xsd">
	<Name>Queue Accounting by Organization</Name>

	<DisplayName>单位</DisplayName>
        <Summary>监视单位作业队列使用计费统计。</Summary>
        <Description><![CDATA[
        <h3>目的</h3>
        <ul type="disc">
                <li>该报表显示所有单位作业队列使用计费。</li>
        </ul>        
	<h3>数据描述</h3>
        <ul type="disc">
                <li>该报表显示在指定时间内所有单位作业队列使用计费。</li>
        </ul>           
]]></Description>
        <Category>LSF</Category>	
	<Folder>QueueAccounting</Folder>
	<Parameters>
		<Parameter Name="TIME" Type="TIMEPICK" Label="时间">
			<Attributes>
				<Attribute Name="startTimeName" Value="StartTime"/>
				<Attribute Name="endTimeName" Value="EndTime"/>
				<Attribute Name="defaultMethod" Value="RELATIVE"/>
				<Attribute Name="timeValue" Value="1"/>
				<Attribute Name="timeUnit" Value="d"/>
				<Attribute Name="timePrecision" Value="HOUR"/>
			</Attributes>
		</Parameter>


		<Parameter Name="SCRIPT" Type="SCRIPT">

                        <Attributes>
                                <Attribute Name="SCRIPT"><![CDATA[
				function createLevelDepOrg() {
					var levelName = document.forms[0].LEVEL;
					if(levelName == null) {
						levelName = document.createElement("input");
						levelName.name = 'LEVEL';
						levelName.id = 'LEVEL';
						levelName.type = 'hidden';
						levelName.value = 'ORGANIZATION';
						document.forms[0].appendChild(levelName);
					} 
					
					var organizationName = document.forms[0].ORGANIZATION;
                                        if(organizationName == null) {
                                                organizationName = document.createElement("input");
                                                organizationName.name = 'ORGANIZATION';
                                                organizationName.id = 'ORGANIZATION';
                                                organizationName.type = 'hidden';
                                                organizationName.value = '';
                                                document.forms[0].appendChild(organizationName);
                                        } 

					var departmentName = document.forms[0].DEPARTMENT;
                                        if(departmentName == null) {
                                                departmentName = document.createElement("input");
                                                departmentName.name = 'DEPARTMENT';
                                                departmentName.id = 'DEPARTMENT';
                                                departmentName.type = 'hidden';
                                                departmentName.value = '';
                                                document.forms[0].appendChild(departmentName);
                                        } 
					
					var userName = document.forms[0].USER;
                                        if(userName == null) {
                                                userName = document.createElement("input");
                                                userName.name = 'USER';
                                                userName.id = 'USER';
                                                userName.type = 'hidden';
                                                userName.value = '';
                                                document.forms[0].appendChild(userName);
                                        } 
				}
			
				function setLevelForOrgQuery(dep_org) {
                                        var level = document.getElementById("LEVEL");
                                        if ( level != null ) {
                                                document.forms[0].LEVEL.value = "DEPARTMENT";
                                        }
					var organization = document.getElementById("ORGANIZATION");
                                        if ( organization != null && dep_org != "") {
                                                document.forms[0].ORGANIZATION.value = dep_org;
                                        }
                                }
	
				function setLevelForDepQuery(dep_org) {
					var level = document.getElementById("LEVEL");
					if ( level != null ) {
						document.forms[0].LEVEL.value = "USER";
					}
					var department = document.getElementById("DEPARTMENT");
                                        if ( department != null && dep_org != "") {
                                                document.forms[0].DEPARTMENT.value = dep_org;
                                        }
				}

				function setLevelForUserQuery(dep_org) {
                                        var level = document.getElementById("LEVEL");
                                        if ( level != null ) {
                                                document.forms[0].LEVEL.value = "DETAIL";
                                        }
                                        var user = document.getElementById("USER");
                                        if ( user != null && dep_org != "") {
                                                document.forms[0].USER.value = dep_org;
                                        }
                                }

				function setDefaultLevel() {
                                        var level = document.getElementById("LEVEL");
                                        if ( level != null ) {
                                                document.forms[0].LEVEL.value = "ORGANIZATION";
                                        }
                                }
				createLevelDepOrg();
				]]></Attribute>
                        </Attributes>
                </Parameter>
	</Parameters>
	<Queries>
		<!--Usage:
		<Query DBType="MySQL"><SQL><![CDATA[select TIME_STAMP as Timestamp, HOSTLIST_ID as HOST,MAX_VALUE as Max, MIN_VALUE as Min, FREE_VALUE as Free from ALLOCATION_REQUEST_EVENT where ParamA=${ParamA} and ParamB=${ParamB} and Timestamp between ${T1} and ${t2}]]></SQL></Query>
		-->
		<Query Name="DS1" DBType="STANDARD" MaxRowNum="100">
			<SQL><![CDATA[
			SELECT UGD.ORGANIZATION_NAME AS ORG_NAME,
			       CAST(SUM(CORE.CORE_RUN_MINUTES / 60) AS NUMERIC(16, 2)) AS ORG_USED_HOURS,
			       CAST(SUM(CORE.CORE_ACCOUNTING / 60) AS NUMERIC(16, 2)) AS ORG_ACCOUNT
			  FROM (SELECT JA.USER_NAME AS CORE_USER_NAME,
				       JA.QUEUE_NAME,	
				       JA.CORE_HOUR,		
			               SUM(JA.RUN_TIME) AS CORE_RUN_MINUTES,
			               SUM(JA.RUN_TIME) * AVG(QR.QUEUE_RATE) AS CORE_ACCOUNTING
			          FROM JOB_ACCOUNTING JA, QUEUE_RATE QR
			         WHERE JA.QUEUE_NAME = QR.QUEUE_NAME 
				    AND JA.CORE_HOUR = QR.BUSINESS_HOUR_CODE
			            AND JA.TIME_STAMP >= ${START_TIMESTAMP}
			            AND JA.TIME_STAMP < ${END_TIMESTAMP} 
				GROUP BY JA.USER_NAME, JA.QUEUE_NAME, JA.CORE_HOUR) CORE,
			       USER_GROUP_DEPARTMENT UGD
			 WHERE UGD.USER_NAME = CORE.CORE_USER_NAME
			 GROUP BY UGD.ORGANIZATION_NAME
			]]></SQL>
		</Query>

		<Query Name="DS2" DBType="STANDARD" MaxRowNum="100">
                        <SQL><![CDATA[
                        SELECT UGD.USER_DEPARTMENT_NAME AS DEP_NAME,
			       UGD.ORGANIZATION_NAME AS ORG_NAME,
			       CAST(SUM(CORE.CORE_RUN_MINUTES / 60) AS NUMERIC(16, 2)) AS DEP_USED_HOURS,
			       CAST(SUM(CORE.CORE_ACCOUNTING / 60) AS NUMERIC(16, 2)) AS DEP_ACCOUNT
			  FROM (SELECT JA.USER_NAME AS CORE_USER_NAME,
				       JA.QUEUE_NAME,
			               JA.CORE_HOUR,  
				       SUM(JA.RUN_TIME) AS CORE_RUN_MINUTES,
			               SUM(JA.RUN_TIME) * AVG(QR.QUEUE_RATE) AS CORE_ACCOUNTING
			          FROM JOB_ACCOUNTING JA, QUEUE_RATE QR
			         WHERE JA.QUEUE_NAME = QR.QUEUE_NAME
				   AND JA.CORE_HOUR = QR.BUSINESS_HOUR_CODE
			           AND JA.TIME_STAMP >= ${START_TIMESTAMP}
			           AND JA.TIME_STAMP < ${END_TIMESTAMP}
			         GROUP BY JA.USER_NAME, JA.QUEUE_NAME, JA.CORE_HOUR) CORE,
			       USER_GROUP_DEPARTMENT UGD
			 WHERE UGD.USER_NAME = CORE.CORE_USER_NAME
			   AND UGD.ORGANIZATION_NAME = '${ORGANIZATION}'
			 GROUP BY UGD.USER_DEPARTMENT_NAME, UGD.ORGANIZATION_NAME
			]]></SQL>
                </Query>

		<Query Name="DS3" DBType="STANDARD" MaxRowNum="100">
                        <SQL><![CDATA[
			 SELECT UGD.USER_DEPARTMENT_NAME AS DEP_NAME,
			        UGD.ORGANIZATION_NAME AS ORG_NAME,
			        UGD.USER_NAME AS USER_NAME,
			        CAST(SUM(CORE.CORE_RUN_MINUTES / 60) AS NUMERIC(16, 2)) AS USER_USED_HOURS,
			        CAST(SUM(CORE.CORE_ACCOUNTING / 60) AS NUMERIC(16, 2)) AS USER_ACCOUNT
			   FROM (SELECT JA.USER_NAME AS CORE_USER_NAME,
					JA.QUEUE_NAME,
					JA.CORE_HOUR, 
			                SUM(JA.RUN_TIME) AS CORE_RUN_MINUTES,
			                SUM(JA.RUN_TIME) * AVG(QR.QUEUE_RATE) AS CORE_ACCOUNTING
			           FROM JOB_ACCOUNTING JA, QUEUE_RATE QR
			          WHERE JA.QUEUE_NAME = QR.QUEUE_NAME
				    AND JA.CORE_HOUR = QR.BUSINESS_HOUR_CODE
			            AND JA.TIME_STAMP >= ${START_TIMESTAMP}
			            AND JA.TIME_STAMP < ${END_TIMESTAMP}
			          GROUP BY JA.USER_NAME, JA.QUEUE_NAME, JA.CORE_HOUR) CORE,
			        USER_GROUP_DEPARTMENT UGD
			  WHERE UGD.USER_NAME = CORE.CORE_USER_NAME
			    AND UGD.ORGANIZATION_NAME = '${ORGANIZATION}'
			    AND UGD.USER_DEPARTMENT_NAME = '${DEPARTMENT}'
			  GROUP BY UGD.USER_NAME, UGD.USER_DEPARTMENT_NAME, UGD.ORGANIZATION_NAME
			]]></SQL>
                </Query>

		<Query Name="DS4" DBType="STANDARD" MaxRowNum="100">
                        <SQL><![CDATA[
                        SELECT UGD.USER_DEPARTMENT_NAME AS DEP_NAME,
			       UGD.ORGANIZATION_NAME AS ORG_NAME,
			       UGD.USER_NAME_CHINESE AS USER_NAME,
			       CORE.CORE_QUEUE_NAME AS USER_QUEUE_NAME,
			       CAST(SUM(CORE.CORE_RUN_MINUTES / 60) AS NUMERIC(16, 2)) AS QUEUE_USED_HOURS,
			       CAST(SUM(CORE.CORE_ACCOUNTING / 60) AS NUMERIC(16, 2)) AS QUEUE_ACCOUNT
			  FROM (SELECT JA.USER_NAME AS CORE_USER_NAME,
			               JA.QUEUE_NAME AS CORE_QUEUE_NAME,
				       JA.CORE_HOUR,
			               SUM(JA.RUN_TIME) AS CORE_RUN_MINUTES,
			               SUM(JA.RUN_TIME) * AVG(QR.QUEUE_RATE) AS CORE_ACCOUNTING
			          FROM JOB_ACCOUNTING JA, QUEUE_RATE QR
			         WHERE JA.QUEUE_NAME = QR.QUEUE_NAME
				   AND JA.CORE_HOUR = QR.BUSINESS_HOUR_CODE
			           AND JA.TIME_STAMP >= ${START_TIMESTAMP}
			           AND JA.TIME_STAMP < ${END_TIMESTAMP}
			         GROUP BY JA.USER_NAME, JA.QUEUE_NAME, JA.CORE_HOUR) CORE,
			       USER_GROUP_DEPARTMENT UGD
			 WHERE UGD.USER_NAME = '${USER}'
			   AND CORE.CORE_USER_NAME = '${USER}'
			   AND UGD.USER_DEPARTMENT_NAME = '${DEPARTMENT}'
			   AND UGD.ORGANIZATION_NAME = '${ORGANIZATION}'
			 GROUP BY UGD.USER_NAME_CHINESE,
			          UGD.USER_DEPARTMENT_NAME,
				  UGD.ORGANIZATION_NAME,
			          CORE.CORE_QUEUE_NAME
			]]></SQL>
                </Query>
	</Queries>
	<Layouts>
		<Layout LEVEL="ORGANIZATION">
                        <Type>TABLE</Type>
                        <DataSetName>DS1</DataSetName>
                        <Title>单位作业队列使用计费</Title>
                        <Subtitles>
                                <Subtitle></Subtitle>
                                <Subtitle></Subtitle>
                        </Subtitles>
                        <!-- The label will display in chart Time-->
                        <TableColumns>
                                <TableColumn Name="ORG_NAME" Label="单位">
					<URL Value="javascript:parent.setLevelForOrgQuery('${ORG_NAME}'); parent.submitShowReport(); parent.setDefaultLevel(); return false;"></URL>
                		</TableColumn>
                                <TableColumn Name="ORG_USED_HOURS" Label="使用时间(小时)" Type="NUMERIC" Format="#,###,###,##0.00" Style="text-align:right"/> 
				<TableColumn Name="ORG_ACCOUNT" Label="总费用(元)" Type="NUMERIC" Format="#,###,###,##0.00" Style="text-align:right"/> 
                        </TableColumns>
                </Layout>

		<Layout LEVEL="DEPARTMENT">
                        <Type>TABLE</Type>
                        <DataSetName>DS2</DataSetName>
                        <Title>单位作业队列使用计费</Title>
                        <Subtitles>
                                <Subtitle></Subtitle>
                                <Subtitle></Subtitle>
                        </Subtitles>
                        <!-- The label will display in chart Time-->
                        <TableColumns>
				<TableColumn Name="ORG_NAME" Label="单位"/>
                                <TableColumn Name="DEP_NAME" Label="部门">
					 <URL Value="javascript:parent.setLevelForDepQuery('${DEP_NAME}'); parent.submitShowReport(); parent.setDefaultLevel(); return false;"></URL>
				</TableColumn>
				<TableColumn Name="DEP_USED_HOURS" Label="使用时间(小时)" Type="NUMERIC" Format="#,###,###,##0.00" Style="text-align:right"/>
				<TableColumn Name="DEP_ACCOUNT" Label="总费用(元)" Type="NUMERIC" Format="#,###,###,##0.00" Style="text-align:right"/> 
                        </TableColumns>
                </Layout>
		
		 <Layout LEVEL="USER">
                        <Type>TABLE</Type>
                        <DataSetName>DS3</DataSetName>
                        <Title>单位作业队列使用计费</Title>
                        <Subtitles>
                                <Subtitle></Subtitle>
                                <Subtitle></Subtitle>
                        </Subtitles>
                        <!-- The label will display in chart Time-->
                        <TableColumns>
                                <TableColumn Name="ORG_NAME" Label="单位"/>
                                <TableColumn Name="DEP_NAME" Label="部门"/>
				<TableColumn Name="USER_NAME" Label="用户">
                                         <URL Value="javascript:parent.setLevelForUserQuery('${USER_NAME}'); parent.submitShowReport(); parent.setDefaultLevel(); return false;"></URL>
                                </TableColumn>
                                <TableColumn Name="USER_USED_HOURS" Label="使用时间(小时)" Type="NUMERIC" Format="#,###,###,##0.00" Style="text-align:right"/>
                                <TableColumn Name="USER_ACCOUNT" Label="总费用(元)" Type="NUMERIC" Format="#,###,###,##0.00" Style="text-align:right"/>
                        </TableColumns>
                </Layout>

		<Layout LEVEL="DETAIL">
                        <Type>TABLE</Type>
                        <DataSetName>DS4</DataSetName>
                        <Title>单位作业队列使用计费</Title>
                        <Subtitles>
                                <Subtitle></Subtitle>
                                <Subtitle></Subtitle>
                        </Subtitles>
                        <!-- The label will display in chart Time-->
                        <TableColumns>
                                <TableColumn Name="ORG_NAME" Label="单位"/>
                                <TableColumn Name="DEP_NAME" Label="部门"/>
				<TableColumn Name="USER_NAME" Label="用户"/>
				<TableColumn Name="USER_QUEUE_NAME" Label="应用程序"/>
				<TableColumn Name="QUEUE_USED_HOURS" Label="使用时间(小时)" Type="NUMERIC" Format="#,###,###,##0.00" Style="text-align:right"/>
				<TableColumn Name="QUEUE_ACCOUNT" Label="总费用(元)" Type="NUMERIC" Format="#,###,###,##0.00" Style="text-align:right"/>
                        </TableColumns>
                </Layout>	
	</Layouts>
	<Variables>
		<Variable Name="StartTime" Target="StartTime" Source="REQUEST" />
		<Variable Name="EndTime" Target="EndTime" Source="REQUEST" />
		
		<!-- Variable used to present report last month of database server. -->
		<Variable Name="LAST_MONTH" Target="REAL_START_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM" />
		</Variable>

		<!-- Variable used to present report current month of database server. -->
		<Variable Name="CURRENT_MONTH" Target="REAL_START_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM" />
		</Variable>

		<Variable Name="REAL_START_TIME" Target="REAL_START_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM-dd HH:mm" />
		</Variable>
		
		<Variable Name="REAL_END_TIME" Target="REAL_END_TIME" Source="REAL_TIME_RANGE" >
			<Format Plug-in="com.platform.perf.report.config.var.format.DateTimeFormat" Pattern="yyyy-MM-dd HH:mm" />
		</Variable>
		<!-- Variables used to build the SQL -->
		<Variable Name="START_TIMESTAMP" Source="QUERY_BUILD_SOURCE" Target="START_TIME" Function="TO_TIMESTAMP" />
		<Variable Name="END_TIMESTAMP" Source="QUERY_BUILD_SOURCE" Target="END_TIME" Function="TO_TIMESTAMP" />
		<Variable Name="TRUNCATED_TIMESTAMP" Source="QUERY_BUILD_SOURCE" Target="TIMESTAMP_COLUMN" Function="TRUNC_TIME_TO_DAY" />

		<Variable Name="DEPARTMENT" Target="DEPARTMENT" Source="REQUEST" />
		<Variable Name="ORGANIZATION" Target="ORGANIZATION" Source="REQUEST" />
		<Variable Name="USER" Target="USER" Source="REQUEST" />
		<Variable Name="LEVEL" Target="LEVEL" Source="REQUEST" />
	</Variables>
	<Sources>
		<Source Name="REQUEST" Plug-in="com.platform.perf.report.config.var.source.RequestVariableSource" />
		<Source Name="REAL_TIME_RANGE" Plug-in="com.platform.perf.report.config.var.source.RealTimeRangeSource">
			<Parameter Name="START_TIME">${StartTime}</Parameter>
			<Parameter Name="END_TIME">${EndTime}</Parameter>
		</Source>
		<Source Name="QUERY_BUILD_SOURCE" Plug-in="com.platform.perf.report.config.var.source.QueryBuildSource">
			<Parameter Name="START_TIME">${StartTime}</Parameter>
			<Parameter Name="END_TIME">${EndTime}</Parameter>
			<Parameter Name="TIMESTAMP_COLUMN">TIME_STAMP</Parameter>
		</Source>
	</Sources>
</Report>
